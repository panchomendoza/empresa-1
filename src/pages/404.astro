---
import { useStoryblokApi } from '@storyblok/astro';
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro';
import MainLayout from '../layouts/MainLayout.astro';

const currentTenantFolder = import.meta.env.PUBLIC_SITE_FOLDER;
const storyblokVersion = import.meta.env.PUBLIC_STORYBLOK_VERSION || 'draft';
const storyblokApi = useStoryblokApi();

// Intentar obtener una página 404 personalizada de Storyblok
let story;
let globalConfig;

try {
    const { data } = await storyblokApi.get(`cdn/stories/${currentTenantFolder}/404`, {
        version: storyblokVersion,
    }) as any;
    story = data.story;
} catch (error) {
    console.log('No se encontró página 404 personalizada en Storyblok');
}

// Obtener configuración global
try {
    const { data: configResponse } = await storyblokApi.get(`cdn/stories/${currentTenantFolder}/settings`, {
        version: storyblokVersion,
    }) as any;
    globalConfig = configResponse.story;
} catch (error) {
    console.error('Error al cargar settings:', error);
}

const seoData = story ? {
    title: story.content.seo_title || '404 - Página no encontrada',
    description: story.content.seo_description || 'La página que buscas no existe',
    image: story.content.og_image?.filename
} : {
    title: '404 - Página no encontrada',
    description: 'La página que buscas no existe'
};

Astro.response.status = 404;
---

<MainLayout 
    title={seoData.title} 
    description={seoData.description}
    image={seoData.image}
    config={globalConfig}
>
    {story ? (
        <StoryblokComponent blok={story.content} />
    ) : (
        <div class="container mx-auto px-4 py-16 text-center">
            <h1 class="text-6xl font-bold text-gray-800 mb-4">404</h1>
            <h2 class="text-3xl font-semibold text-gray-600 mb-8">Página no encontrada</h2>
            <p class="text-xl text-gray-500 mb-8">
                Lo sentimos, la página que buscas no existe.
            </p>
            <a 
                href="/" 
                class="inline-block bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors"
            >
                Volver al inicio
            </a>
        </div>
    )}
</MainLayout>
