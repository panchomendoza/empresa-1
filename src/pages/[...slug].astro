---
import { useStoryblokApi } from '@storyblok/astro';
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro';
import MainLayout from '../layouts/MainLayout.astro';

export const prerender = import.meta.env.PUBLIC_STORYBLOK_VERSION !== 'draft';

const currentTenantFolder = import.meta.env.PUBLIC_SITE_FOLDER;
const storyblokVersion = import.meta.env.PUBLIC_STORYBLOK_VERSION || 'draft';

export async function getStaticPaths() {
  const storyblokApi = useStoryblokApi();
  const currentTenantFolder = import.meta.env.PUBLIC_SITE_FOLDER;
  const storyblokVersion = import.meta.env.PUBLIC_STORYBLOK_VERSION;
  
  const { data } = await storyblokApi.get('cdn/stories', {
    version: storyblokVersion,
    starts_with: `${currentTenantFolder}/`,
  });

  return data.stories
    .filter((story: any) => 
        story.content.component !== 'global' && 
        story.slug !== 'settings' && 
        story.slug !== 'home' // Excluimos home porque ya tiene su index.astro
    ) 
    .map((story: any) => {
      const slugWithoutFolder = story.full_slug.replace(`${currentTenantFolder}/`, '');
      return {
        params: { slug: slugWithoutFolder },
      };
    });
}

const { slug } = Astro.params;


const storyblokApi = useStoryblokApi();
const fullSlug = `${currentTenantFolder}/${slug}`;

// 1. Obtener la Página
const { data } = await storyblokApi.get(`cdn/stories/${fullSlug}`, {
  version: storyblokVersion,
}) as any;
const story = data.story;

// 2. Extraer SEO (Consistente con los nombres de campos de tu Storyblok)
const seoData = {
  title: story.content.seo_title || story.content.seo?.title || story.name,
  description: story.content.seo_description || story.content.seo?.description,
  image: story.content.og_image?.filename
};

// 3. Obtener Configuración Global
let globalConfig;
try {
    const { data: configResponse } = await storyblokApi.get(`cdn/stories/${currentTenantFolder}/settings`, {
        version: storyblokVersion,
    }) as any;
    globalConfig = configResponse.story;
} catch (error) {
    console.error(`Error settings:`, error);
}
---

<MainLayout 
    title={seoData.title} 
    description={seoData.description}
    image={seoData.image}
    config={globalConfig}
>
    <StoryblokComponent blok={story.content} />
</MainLayout>