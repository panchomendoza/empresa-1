---
import { useStoryblokApi } from '@storyblok/astro';
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro';
import MainLayout from '../layouts/MainLayout.astro';

// Identificar la empresa actual desde las variables de entorno
const currentTenantFolder = import.meta.env.PUBLIC_SITE_FOLDER;

// getStaticPaths solo se ejecuta en modo SSG (static)
// En modo SSR (server), esta funci贸n no se ejecuta
export async function getStaticPaths() {
  const storyblokApi = useStoryblokApi();
  const currentTenantFolder = import.meta.env.PUBLIC_SITE_FOLDER;
  const storyblokVersion = import.meta.env.PUBLIC_STORYBLOK_VERSION;
  console.log(" ~ getStaticPaths ~ currentTenantFolder:", currentTenantFolder)
  console.log(" ~ getStaticPaths ~ storyblokVersion:", storyblokVersion)
  
  // Traemos solo las p谩ginas de la empresa actual
  const { data } = await storyblokApi.get('cdn/stories', {
    version: storyblokVersion,
    starts_with: `${currentTenantFolder}/`,
  });

  const paths = data.stories
    .filter((story: any) => story.content.component !== 'global') // Excluir tipo Global
    .map((story: any) => {
      // Remover el prefijo de la empresa del slug
      const slugWithoutFolder = story.full_slug.replace(`${currentTenantFolder}/`, '');
      return {
        params: { slug: slugWithoutFolder || 'index' },
      };
    });
  return paths;
}

const { slug = 'index' } = Astro.params as { slug?: string };
const storyblokApi = useStoryblokApi();
const storyblokVersion = import.meta.env.PUBLIC_STORYBLOK_VERSION || 'draft';

// Construir el slug completo con la carpeta de la empresa
const fullSlug = slug === 'index' ? currentTenantFolder : `${currentTenantFolder}/${slug}`;

// 1. Obtener la Historia (P谩gina) actual
const { data } = await storyblokApi.get(`cdn/stories/${fullSlug}`, {
  version: storyblokVersion,
}) as any;
const story = data.story;

// console.log(' Story data:', JSON.stringify(story, null, 2));
// console.log(' Story content:', JSON.stringify(story.content, null, 2));

// 2. Obtener la Configuraci贸n Global de la empresa actual
let globalConfig;
try {
    const { data: configResponse } = await storyblokApi.get(`cdn/stories/${currentTenantFolder}/settings`, {
        version: storyblokVersion,
    }) as any;
    globalConfig = configResponse.story;
    // console.log('锔 Global config:', JSON.stringify(globalConfig, null, 2));
} catch (error) {
    console.error(`No se encontr贸 configuraci贸n para: ${currentTenantFolder}`, error);
    // Podr铆as cargar una config por defecto aqu铆 si falla
}

---

<MainLayout 
    title={story.content.seo?.title || story.name} 
    description={story.content.seo?.description}
    config={globalConfig}
>
    <StoryblokComponent blok={story.content} />
</MainLayout>