---
import { useStoryblokApi } from '@storyblok/astro';
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro';
import MainLayout from '../layouts/MainLayout.astro';

const currentTenantFolder = import.meta.env.PUBLIC_SITE_FOLDER;
const storyblokVersion = import.meta.env.PUBLIC_STORYBLOK_VERSION || 'draft';

export async function getStaticPaths() {
  const storyblokApi = useStoryblokApi();
  const currentTenantFolder = import.meta.env.PUBLIC_SITE_FOLDER;
  const storyblokVersion = import.meta.env.PUBLIC_STORYBLOK_VERSION;
  
  const { data } = await storyblokApi.get('cdn/stories', {
    version: storyblokVersion,
    starts_with: `${currentTenantFolder}/`,
  });

  return data.stories
    .filter((story: any) => story.content.component !== 'global' && story.slug !== 'settings') 
    .map((story: any) => {
      const slugWithoutFolder = story.full_slug.replace(`${currentTenantFolder}/`, '');
      return {
        params: { slug: slugWithoutFolder || 'index' },
      };
    });
}

const { slug = 'index' } = Astro.params;

if (slug.startsWith('_vercel/') || slug.startsWith('assets/')) {
  return Astro.redirect('/404', 404);
}

const storyblokApi = useStoryblokApi();
const fullSlug = slug === 'index' ? currentTenantFolder : `${currentTenantFolder}/${slug}`;

// 1. Obtener la Página actual
const { data } = await storyblokApi.get(`cdn/stories/${fullSlug}`, {
  version: storyblokVersion,
}) as any;
const story = data.story;

// 2. Extraer datos de SEO (asumiendo nombres de campos: seo_title, seo_description, og_image)
const seoData = {
  title: story.content.seo_title || story.name,
  description: story.content.seo_description,
  image: story.content.og_image?.filename // Extraemos la URL del asset de Storyblok
};

// 3. Obtener Configuración Global
let globalConfig;
try {
    const { data: configResponse } = await storyblokApi.get(`cdn/stories/${currentTenantFolder}/settings`, {
        version: storyblokVersion,
    }) as any;
    globalConfig = configResponse.story;
} catch (error) {
    console.error(`Error cargando settings para: ${currentTenantFolder}`, error);
}
---

<MainLayout 
    title={seoData.title} 
    description={seoData.description}
    image={seoData.image}
    config={globalConfig}
>
    <StoryblokComponent blok={story.content} />
</MainLayout>