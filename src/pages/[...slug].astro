---
import { useStoryblokApi } from '@storyblok/astro';
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro';
import MainLayout from '../layouts/MainLayout.astro';

// Identificar la empresa actual desde las variables de entorno
const currentTenantFolder = import.meta.env.PUBLIC_SITE_FOLDER || 'empresa-1';

export async function getStaticPaths() {
  const storyblokApi = useStoryblokApi();
  const tenantFolder = import.meta.env.PUBLIC_SITE_FOLDER || 'empresa-1';
  
  // Traemos solo las p치ginas de la empresa actual
  const { data } = await storyblokApi.get('cdn/stories', {
    version: 'draft',
    starts_with: `${tenantFolder}/`,
  });

  const paths = data.stories
    .filter((story: any) => story.content.component !== 'global') // Excluir tipo Global
    .map((story: any) => {
      // Remover el prefijo de la empresa del slug
      const slugWithoutFolder = story.full_slug.replace(`${tenantFolder}/`, '');
      return {
        params: { slug: slugWithoutFolder || 'index' },
      };
    });
  return paths;
}

const { slug } = Astro.params as { slug: string };
const storyblokApi = useStoryblokApi();

// Construir el slug completo con la carpeta de la empresa
const fullSlug = slug === 'index' ? currentTenantFolder : `${currentTenantFolder}/${slug}`;

// 1. Obtener la Historia (P치gina) actual
const { data } = await storyblokApi.get(`cdn/stories/${fullSlug}`, {
  version: 'draft',
}) as any;
const story = data.story;

console.log('游늯 Story data:', JSON.stringify(story, null, 2));
console.log('游늯 Story content:', JSON.stringify(story.content, null, 2));

// 2. Obtener la Configuraci칩n Global de la empresa actual
let globalConfig;
try {
    const { data: configResponse } = await storyblokApi.get(`cdn/stories/${currentTenantFolder}/settings`, {
        version: 'draft',
    }) as any;
    globalConfig = configResponse.story;
    console.log('丘뙖잺 Global config:', JSON.stringify(globalConfig, null, 2));
} catch (error) {
    console.error(`No se encontr칩 configuraci칩n para: ${currentTenantFolder}`, error);
    // Podr칤as cargar una config por defecto aqu칤 si falla
}

---

<MainLayout 
    title={story.content.seo?.title || story.name} 
    description={story.content.seo?.description}
    config={globalConfig}
>
    <StoryblokComponent blok={story.content} />
</MainLayout>